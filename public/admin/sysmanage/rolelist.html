<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" type="text/css" href="../easyui/themes/default/easyui.css">
<link rel="stylesheet" type="text/css" href="../easyui/themes/icon.css">
<script type="text/javascript" src="../easyui/jquery.min.js"></script>
<script type="text/javascript" src="../easyui/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../js/common.js"></script>
<title>角色管理</title>
<script>
	//页面加载
	$(document).ready(function () {
		BindData();
		$("#tt").datagrid('getPager').pagination({
			onSelectPage:function(pageNum, pageSize){
				opts.pageNumber = pageNum;
				opts.pageSize = pageSize;
				BindData();
			}
		});
	});
	//绑定数据
	function BindData() {
		var pageNumber = $("#tt").datagrid('getPager').data("pagination").options.pageNumber;
		var pageSize = $("#tt").datagrid('getPager').data("pagination").options.pageSize;
		$.ajax({
			type: "get",
			url: _url+'office/sys/role',
			data: {},
			dataType: "text",
			success: function (result) {
				if(JSON.parse(result).result=="2000")
					$("#tt").datagrid("loadData", JSON.parse(result).data);
			},
			error: function () {
				alert("加载失败!");
			}
		});
	}
	//功能菜单按钮点击事件
	function toolBarClick(ty) {
		$("#displayinfo").attr("fnty", ty);
		switch (ty) {
			case "resh"://刷新
				BindData();
				break;
			case "add"://添加
				$('#role-dlg').dialog({ title: "添加角色" });
				clearAllInputValue();//
				$('#role-dlg').dialog('open');
				break;
			case "upd"://更新
				var sdata = $("#tt").datagrid("getSelected");
				if (sdata) {
					clearAllInputValue();
					putDataToWindow(sdata);
					$('#role-dlg').dialog({ title: "编辑角色" });
					$('#role-dlg').dialog('open');
				} else {
					$.messager.alert("提示", "请选择要编辑的角色！", "alert");
				}
				break;
			case "del"://删除
				deleteRole();
				break;
			default:
				break;
		}
	}
	//清空页面元素
	function clearAllInputValue(){
		$("#role_name").val("");//角色名称
	}
	//绑定页面元素
	function putDataToWindow(data) {
		$("#role_name").val(data.r_name);//角色名称
	}
	//输入检查
	function ckeckValue(obj) {
		var sid = $(obj).attr("id");
		var __val = $(obj).val();
		if (sid == "role_name") {
			if (__val == "") {
				$(obj).parent().next().children().show();
				return false;
			} else {
				clearError(obj);
				return true;
			}
		}
	}
	//清空错误信息
	function clearError(obj){
		$(obj).parent().next().children().hide();
	}
	//删除用户
	function deleteRole() {
		var sdata = $("#tt").datagrid("getSelected");
		if (sdata) {
			$.messager.confirm("提示", "确认删除选中的角色！", function (r) {
				if (r) {
					$.ajax({
						type: "delete",
						url: _url+'office/sys/role/{'+sdata.id+'}',
						data: {},
						dataType: "text",
						success: function (r) {
							var result = JSON.parse(r);
							$.messager.alert('提示', result.info, 'info');
							BindData();
						},
						error: function () {
							alert("操作失败!");
						}
					});
				}
			});
		} else {
			$.messager.alert("提示", "请选择要删除的角色！", "alert");
		}
	}
	//获取页面元素值
	function getDataFromWindow(){
		var rsData = { data: "", flag: true };
		var roleObj = {};
		if (ckeckValue($("#role_name"))) {//角色名称
			roleObj.r_name = $("#role_name").val();
		} else {
			rsData.flag = false;
		}
		roleObj.r_memo = $("#role_remark").val();
		rsData.data = roleObj;
		return rsData;
	}
	//保存按钮点击事件
	function saveRoleClick(){
		var fnty = $("#displayinfo").attr("fnty");//读取操作类型
		var rsData = getDataFromWindow();
		if (rsData.flag) {
			//添加
			if (fnty == "add") {
				//调用后台添加接口
				$.ajax({
					type: "post",
					url: _url+'office/sys/role',
					data: {name:rsData.data.r_name,desc:rsData.data.r_memo},
					dataType: "text",
					success: function (r) {
						var result = JSON.parse(r);
						alert(result.info);
						if(result.result=="2000"){
							$("#role-dlg").dialog("close");
							BindData();
						}
					},
					error: function () {
						alert("操作失败!");
					}
				});
			} else if (fnty == "upd") {//编辑
				//获取选中角色
				var sdata = $("#tt").datagrid("getSelected");
				//获取选中角色索引
				var rowindex = $("#tt").datagrid("getRowIndex", sdata);
				//设置修改角色id
				rsData.data.id = sdata.id;
				//调用后台编辑接口
				$.ajax({
					type: "put",
					url: _url+'office/sys/role/'+rsData.data.id,
					data: {name:rsData.data.r_name,desc:rsData.data.r_memo},
					dataType: "text",
					success: function (r) {
						var result = JSON.parse(r);
						alert(result.info);
						if(result.result=="2000"){
							$("#role-dlg").dialog("close");
							BindData();
						}
					},
					error: function () {
						alert("操作失败!");
					}
				});
			}
		}
	}
	function formatHandle(value, row) {
		var rs  = '<a class="alink-edit" onclick="setUser()" href="#">[设置用户]</a>';
		return rs;
	}
	function setUser(){
		alert("coding");
	}
</script>
</head>

<body>
<table id="tt" title="角色列表" class="easyui-datagrid" data-options="
            rownumbers:true,
            fit:true,
            singleSelect:true,
            pagination:true,
            pageSize:20,
            idField:'id',
            toolbar:'#menuTollbar'">
    <thead>
        <tr>
            <th data-options="field:'id',width:120,align:'left',halign:'center'">id</th>
            <th data-options="field:'r_name',width:120,align:'left',halign:'center'">角色名称</th>
            <th data-options="field:'r_memo',width:80,align:'left',halign:'center'">角色描述</th>
            <th data-options="field:'options',width:140,align:'center',formatter:formatHandle">操作</th>
        </tr>
    </thead>
</table>
<div id="menuTollbar" style="height: auto;">
    <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-reload'" onclick="toolBarClick('resh');">刷新</a>
    <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-add'" onclick="toolBarClick('add');">添加</a>
    <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-edit'" onclick="toolBarClick('upd');">编辑</a>
    <a href="#" class="easyui-linkbutton" data-options="plain:true,iconCls:'icon-remove'" onclick="toolBarClick('del');">删除</a>
</div>

<!-- 添加/编辑窗口 Start -->
<div id="role-dlg" class="easyui-dialog" title="添加角色" style="width: 400px; height: 330px; padding: 5px"
    data-options="
        closed:true,
        modal:true,
        iconCls: 'icon-save',
        buttons: '#role-dlg-buttons'
    ">
    <div>
        <div id="displayinfo" fnty="add" style="display: none;">信息存储隐藏层</div>
        <table class="userTab">
            <tr>
                <td class="td-key">角色名称</td>
                <td style="width: 100px;">
                    <input id="role_name" next="role_remark" type="text"  onblur="ckeckValue(this);" onfocus="clearError(this);" /></td>
                <td>
                    <div style="color: red; display: none;">请输入角色名称!</div>
                </td>
            </tr>
            <tr>
                <td class="td-key">角色描述</td>
                <td>
                    <input id="role_remark" type="text" /></td>
                <td>
                    
                </td>
            </tr>
        </table>
    </div>
</div>
<div id="role-dlg-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-ok'" onclick="saveRoleClick();">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-no'" onclick="$('#role-dlg').dialog('close');">取消</a>
</div>
<!-- 添加/编辑窗口 End -->
</body>
</html>
